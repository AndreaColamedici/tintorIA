<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TintorIA â€” L'archivio intelligente di Tintoria</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#13131a;--surface2:#1a1a25;--surface3:#22222f;
  --border:#2a2a3a;--text:#e8e8f0;--text2:#9898a8;--text3:#686878;
  --accent:#ff6b35;--accent2:#ff8c5a;--accent-glow:rgba(255,107,53,0.15);
  --green:#4ade80;--red:#f87171;--blue:#60a5fa;--purple:#a78bfa;--yellow:#fbbf24;
  --pink:#f472b6;--cyan:#22d3ee;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}a:hover{color:var(--accent2)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

/* Navigation */
.nav{position:sticky;top:0;z-index:100;background:rgba(10,10,15,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px}
.nav-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;height:56px;gap:8px}
.nav-logo{font-weight:800;font-size:20px;color:var(--accent);margin-right:24px;cursor:pointer}
.nav-tab{padding:8px 16px;border-radius:8px;font-size:14px;font-weight:500;color:var(--text2);cursor:pointer;transition:all 0.2s;border:none;background:none}
.nav-tab:hover{color:var(--text);background:var(--surface2)}
.nav-tab.active{color:var(--accent);background:var(--accent-glow)}
.nav-search{margin-left:auto;position:relative}
.nav-search input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 14px 8px 36px;color:var(--text);font-size:14px;width:240px;transition:all 0.3s}
.nav-search input:focus{outline:none;border-color:var(--accent);width:320px;background:var(--surface3)}
.nav-search .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px}
.nav-shortcut{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--text3);background:var(--surface);padding:2px 6px;border-radius:4px;border:1px solid var(--border);font-family:'JetBrains Mono'}

/* Hero */
.hero{padding:48px 24px 32px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 50% 80%,var(--accent-glow) 0%,transparent 50%);pointer-events:none}
.hero h1{font-size:48px;font-weight:900;margin-bottom:8px;position:relative}
.hero h1 span{color:var(--accent)}
.hero .subtitle{color:var(--text2);font-size:16px;margin-bottom:24px;position:relative}
.hero-stats{display:flex;justify-content:center;gap:32px;flex-wrap:wrap;position:relative}
.hero-stat{text-align:center}
.hero-stat .num{font-size:28px;font-weight:800;color:var(--accent)}
.hero-stat .label{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* Main content */
.main{max-width:1400px;margin:0 auto;padding:0 24px 80px}

/* Section headers */
.section-header{display:flex;align-items:center;justify-content:space-between;margin:32px 0 16px;flex-wrap:wrap;gap:12px}
.section-title{font-size:22px;font-weight:700}
.section-subtitle{color:var(--text2);font-size:14px}

/* Filters bar */
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
.filter-chip{padding:6px 14px;border-radius:20px;font-size:13px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;transition:all 0.2s;white-space:nowrap}
.filter-chip:hover{border-color:var(--text3);color:var(--text)}
.filter-chip.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.filter-chip .count{font-size:11px;opacity:0.6;margin-left:4px}

/* Controls */
.controls{display:flex;gap:8px;align-items:center}
.control-btn{padding:6px 12px;border-radius:6px;font-size:13px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;transition:all 0.2s}
.control-btn:hover{border-color:var(--text3);color:var(--text)}
.control-btn.active{border-color:var(--accent);color:var(--accent)}
.sort-select{background:var(--surface);border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:6px;font-size:13px;cursor:pointer}

/* Episode grid */
.ep-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.ep-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.2s}
.ep-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.3)}
.ep-card .thumb{position:relative;padding-top:56.25%;background:var(--surface2)}
.ep-card .thumb img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
.ep-card .thumb .duration{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.8);padding:2px 6px;border-radius:4px;font-size:12px;font-family:'JetBrains Mono'}
.ep-card .thumb .ep-num{position:absolute;top:8px;left:8px;background:var(--accent);padding:2px 8px;border-radius:4px;font-size:12px;font-weight:700}
.ep-card .thumb .fav-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);border:none;color:var(--text3);font-size:18px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.ep-card .thumb .fav-btn:hover,.ep-card .thumb .fav-btn.faved{color:var(--red)}
.ep-card .info{padding:12px 14px}
.ep-card .info .guest{font-weight:600;font-size:15px;margin-bottom:4px;line-height:1.3}
.ep-card .info .meta{display:flex;gap:8px;font-size:12px;color:var(--text3);margin-bottom:8px;flex-wrap:wrap}
.ep-card .info .tags{display:flex;gap:4px;flex-wrap:wrap}
.ep-card .info .tag{font-size:11px;padding:2px 8px;border-radius:10px;background:var(--surface2);color:var(--text3);cursor:pointer;transition:all 0.15s}
.ep-card .info .tag:hover{color:var(--accent);background:var(--accent-glow)}
.ep-card .info .tag.ambito{color:var(--blue);background:rgba(96,165,250,0.1)}
.ep-card .cid-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--yellow);background:rgba(251,191,36,0.1);padding:2px 8px;border-radius:10px;margin-top:4px}

/* Episode list */
.ep-list .ep-row{display:flex;align-items:center;gap:16px;padding:12px 16px;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1px solid transparent}
.ep-list .ep-row:hover{background:var(--surface);border-color:var(--border)}
.ep-list .ep-row .num{font-size:13px;color:var(--text3);width:40px;text-align:right;font-family:'JetBrains Mono'}
.ep-list .ep-row .guest{flex:1;font-weight:500}
.ep-list .ep-row .meta-item{font-size:13px;color:var(--text3);min-width:60px;text-align:right}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:200;display:flex;justify-content:center;overflow-y:auto;padding:24px}
.modal{background:var(--bg);border:1px solid var(--border);border-radius:16px;width:100%;max-width:900px;margin:auto;position:relative;max-height:calc(100vh - 48px);overflow-y:auto}
.modal-close{position:sticky;top:16px;float:right;margin-right:16px;z-index:10;background:var(--surface2);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
.modal-hero{position:relative;padding-top:40%}
.modal-hero img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
.modal-hero .overlay{position:absolute;bottom:0;left:0;right:0;padding:24px;background:linear-gradient(transparent,var(--bg))}
.modal-body{padding:0 24px 24px}
.modal-title{font-size:28px;font-weight:800;margin-bottom:4px}
.modal-guest{font-size:18px;color:var(--text2);margin-bottom:16px}
.modal-meta{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;font-size:14px;color:var(--text3)}
.modal-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}
.modal-tags .tag{padding:4px 12px;border-radius:16px;font-size:13px;background:var(--surface2);color:var(--text2);cursor:pointer}
.modal-tags .tag:hover{color:var(--accent)}
.modal-tags .tag.ambito{color:var(--blue);background:rgba(96,165,250,0.1)}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.btn{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text)}.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn-cid{background:rgba(251,191,36,0.15);border:1px solid var(--yellow);color:var(--yellow)}.btn-cid:hover{background:rgba(251,191,36,0.25)}

/* Transcript */
.transcript-section{margin-top:20px;border-top:1px solid var(--border);padding-top:16px}
.transcript-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text2);font-size:14px;font-weight:500}
.transcript-toggle:hover{color:var(--text)}
.transcript-search{margin:12px 0;position:relative}
.transcript-search input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:14px}
.transcript-search input:focus{outline:none;border-color:var(--accent)}
.transcript-text{font-size:14px;line-height:1.8;color:var(--text2);max-height:500px;overflow-y:auto;padding:12px;background:var(--surface);border-radius:8px;font-family:'Inter',sans-serif;white-space:pre-wrap}

/* CID Section */
.cid-section{margin-top:24px}
.cid-intro{background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(255,107,53,0.08));border:1px solid rgba(251,191,36,0.2);border-radius:16px;padding:24px;margin-bottom:20px}
.cid-intro h3{font-size:20px;margin-bottom:8px}
.cid-intro p{color:var(--text2);font-size:14px;line-height:1.6}
.cid-stats{display:flex;gap:20px;margin-top:16px;flex-wrap:wrap}
.cid-stat{text-align:center}
.cid-stat .n{font-size:24px;font-weight:800;color:var(--yellow)}
.cid-stat .l{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.cid-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.2s}
.cid-card:hover{border-color:var(--yellow);transform:translateY(-2px)}
.cid-card .cid-top{display:flex;gap:12px;padding:14px}
.cid-card .cid-thumb{width:120px;height:68px;border-radius:6px;object-fit:cover;flex-shrink:0}
.cid-card .cid-info{flex:1;min-width:0}
.cid-card .cid-guest{font-weight:600;font-size:14px;margin-bottom:2px}
.cid-card .cid-meta{font-size:12px;color:var(--text3)}
.cid-card .cid-preview{font-size:12px;color:var(--text3);padding:0 14px 12px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cid-card .story-badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:10px;margin-top:4px}
.cid-card .story-badge.yes{color:var(--green);background:rgba(74,222,128,0.1)}
.cid-card .story-badge.no{color:var(--red);background:rgba(248,113,113,0.1)}

/* Guests Section */
.guest-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.guest-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s}
.guest-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.guest-card .g-name{font-weight:600;font-size:16px;margin-bottom:4px}
.guest-card .g-count{color:var(--accent);font-size:13px;margin-bottom:8px}
.guest-card .g-episodes{font-size:12px;color:var(--text3);line-height:1.6}

/* Stats Section */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s}
.stat-card:hover{border-color:var(--accent)}
.stat-card .stat-emoji{font-size:28px;margin-bottom:8px}
.stat-card .stat-label{font-size:13px;color:var(--text3);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.stat-card .stat-value{font-size:18px;font-weight:700;margin-bottom:4px}
.stat-card .stat-detail{font-size:13px;color:var(--text2)}

/* Discovery flow */
.discovery{text-align:center;padding:32px 0}
.discovery h3{font-size:24px;font-weight:700;margin-bottom:8px}
.discovery p{color:var(--text2);margin-bottom:24px}
.discovery-step{margin-bottom:24px}
.discovery-q{font-size:16px;font-weight:500;margin-bottom:12px}
.discovery-opts{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.discovery-opt{padding:10px 20px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;transition:all 0.2s;font-size:14px}
.discovery-opt:hover{border-color:var(--accent);color:var(--accent)}
.discovery-opt.selected{border-color:var(--accent);background:var(--accent-glow);color:var(--accent)}
.discovery-result{background:var(--surface);border:1px solid var(--accent);border-radius:16px;padding:24px;max-width:500px;margin:0 auto;cursor:pointer;transition:all 0.2s}
.discovery-result:hover{transform:scale(1.02)}

/* Timeline */
.timeline{margin:24px 0;padding:16px 0}
.timeline-bar{display:flex;height:48px;border-radius:8px;overflow:hidden;gap:2px}
.timeline-segment{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;cursor:pointer;transition:all 0.2s;border-radius:4px;min-width:16px}
.timeline-segment:hover{background:var(--surface2)}
.timeline-segment .bar{width:100%;background:var(--accent);border-radius:2px;transition:all 0.2s;min-height:2px}
.timeline-segment:hover .bar{background:var(--accent2)}
.timeline-segment .label{font-size:10px;color:var(--text3);margin-top:4px;white-space:nowrap}
.timeline-segment.active .bar{background:var(--yellow)}

/* Favorites section */
.fav-empty{text-align:center;padding:48px;color:var(--text3)}
.fav-empty .icon{font-size:48px;margin-bottom:12px}

/* Search results */
.search-results{margin-top:8px}
.search-result{padding:12px 16px;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1px solid transparent;margin-bottom:4px}
.search-result:hover{background:var(--surface);border-color:var(--border)}
.search-result .sr-guest{font-weight:600;margin-bottom:4px}
.search-result .sr-snippet{font-size:13px;color:var(--text2);line-height:1.5}
.search-result mark{background:var(--accent-glow);color:var(--accent);padding:0 2px;border-radius:2px}

/* Back to top */
.back-top{position:fixed;bottom:24px;right:24px;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all 0.3s;z-index:50;box-shadow:0 4px 16px rgba(255,107,53,0.3)}
.back-top.visible{opacity:1}
.back-top:hover{transform:scale(1.1)}

/* Count badge */
.results-count{font-size:13px;color:var(--text3);margin-bottom:12px}

/* Responsive */
@media(max-width:768px){
  .hero h1{font-size:32px}
  .hero-stats{gap:16px}
  .hero-stat .num{font-size:22px}
  .nav-search input{width:160px}.nav-search input:focus{width:200px}
  .ep-grid{grid-template-columns:1fr}
  .modal{margin:0;border-radius:12px 12px 0 0;max-height:100vh}
  .nav-tab{padding:6px 10px;font-size:13px}
  .nav-shortcut{display:none}
  .stats-grid{grid-template-columns:1fr}
}

/* Loading */
.loading{text-align:center;padding:48px;color:var(--text3)}
.spinner{display:inline-block;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState, useEffect, useMemo, useCallback, useRef} = React;

// ========== UTILITIES ==========
const fmt = n => n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n.toString();
const fmtDate = d => {if(!d)return'';const[y,m,dd]=d.split('-');const months=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];return`${parseInt(dd)} ${months[parseInt(m)-1]} ${y}`};
const fmtDur = s => {const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return h?`${h}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`:`${m}:${String(ss).padStart(2,'0')}`};

function highlight(text, query) {
  if (!query || query.length < 3) return text;
  const parts = text.split(new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'));
  return parts.map((p,i) => p.toLowerCase()===query.toLowerCase() ? React.createElement('mark',{key:i},p) : p);
}

function getSnippet(text, query, contextLen=80) {
  if (!query || !text) return '';
  const idx = text.toLowerCase().indexOf(query.toLowerCase());
  if (idx === -1) return text.slice(0, 200);
  const start = Math.max(0, idx - contextLen);
  const end = Math.min(text.length, idx + query.length + contextLen);
  return (start > 0 ? 'â€¦' : '') + text.slice(start, end) + (end < text.length ? 'â€¦' : '');
}

// ========== FAVORITES ==========
function loadFavs() { try { return JSON.parse(localStorage.getItem('tintoria_favs')||'[]') } catch(e) { return [] } }
function saveFavs(f) { localStorage.setItem('tintoria_favs', JSON.stringify(f)) }
function toggleFav(id, favs, setFavs) {
  const next = favs.includes(id) ? favs.filter(f=>f!==id) : [...favs, id];
  setFavs(next); saveFavs(next);
}

// ========== GUEST INDEX ==========
function buildGuestIndex(episodes) {
  const idx = {};
  episodes.forEach(ep => {
    if (!ep.is_numbered) return;
    let g = ep.guest || '';
    const hasRapone = /rapone/i.test(g);
    g = g.replace(/^LIVE\s+/, '');
    g = g.replace(/\s*\(con Stefano Rapone\)/i, '');
    g = g.replace(/\s*con \(Stefano Rapone\)/i, '');
    g = g.replace(/\s*feat\s+Stefano Rapone/i, '');
    const parts = g.split(/\s*[&,]\s*|\s+e\s+/);
    parts.forEach(p => {
      let name = p.trim();
      if (!name || name.length < 3) return;
      if (name.includes(' aka ')) {
        const [a, b] = name.split(' aka ');
        if (!idx[a.trim()]) idx[a.trim()] = [];
        idx[a.trim()].push(ep);
      }
      if (!idx[name]) idx[name] = [];
      idx[name].push(ep);
    });
    if (hasRapone) {
      if (!idx['Stefano Rapone']) idx['Stefano Rapone'] = [];
      idx['Stefano Rapone'].push(ep);
    }
  });
  // Deduplicate
  Object.keys(idx).forEach(k => {
    const seen = new Set();
    idx[k] = idx[k].filter(ep => { if(seen.has(ep.episode_number)) return false; seen.add(ep.episode_number); return true; });
    idx[k].sort((a,b) => a.episode_number - b.episode_number);
  });
  return idx;
}

// ========== STATS ==========
function buildStats(episodes, meta) {
  const numbered = episodes.filter(e => e.is_numbered);
  const withViews = numbered.filter(e => e.view_count);
  const sorted = [...withViews].sort((a,b) => b.view_count - a.view_count);
  const byDuration = [...numbered].filter(e=>e.duration_seconds).sort((a,b) => b.duration_seconds - a.duration_seconds);
  const totalWords = meta.total_transcript_words || 0;
  
  // Episodes per year
  const perYear = {};
  numbered.forEach(ep => { const y = (ep.upload_date||'').slice(0,4); if(y) perYear[y] = (perYear[y]||0)+1; });
  const busiestYear = Object.entries(perYear).sort((a,b)=>b[1]-a[1])[0];
  
  // Total hours
  const totalSec = numbered.reduce((s,e) => s + (e.duration_seconds||0), 0);
  const totalHours = Math.round(totalSec / 3600);
  
  return [
    { emoji:'ðŸ‘‘', label:'Episodio piÃ¹ visto', value: `#${sorted[0]?.episode_number} ${sorted[0]?.guest}`, detail:`${fmt(sorted[0]?.view_count)} visualizzazioni`, ep: sorted[0] },
    { emoji:'ðŸ’Ž', label:'Gemma nascosta', value: `#${sorted[sorted.length-1]?.episode_number} ${sorted[sorted.length-1]?.guest}`, detail:`Solo ${fmt(sorted[sorted.length-1]?.view_count)} visualizzazioni`, ep: sorted[sorted.length-1] },
    { emoji:'ðŸ•', label:'Maratona piÃ¹ lunga', value: `#${byDuration[0]?.episode_number} ${byDuration[0]?.guest}`, detail:fmtDur(byDuration[0]?.duration_seconds), ep: byDuration[0] },
    { emoji:'âš¡', label:'Episodio piÃ¹ breve', value: `#${byDuration[byDuration.length-1]?.episode_number} ${byDuration[byDuration.length-1]?.guest}`, detail:fmtDur(byDuration[byDuration.length-1]?.duration_seconds), ep: byDuration[byDuration.length-1] },
    { emoji:'ðŸ“…', label:'Anno piÃ¹ prolifico', value: busiestYear ? `${busiestYear[0]}` : '?', detail: busiestYear ? `${busiestYear[1]} episodi pubblicati` : '' },
    { emoji:'ðŸŽ™ï¸', label:'Ore totali di podcast', value: `${totalHours} ore`, detail:`${totalWords ? (totalWords/1e6).toFixed(1)+'M' : '?'} parole trascritte` },
    { emoji:'ðŸ’©', label:'Rubrica "Cacare in discoteca"', value: `${meta.rubrica_cid_count || 0} episodi`, detail:`${meta.rubrica_cid_stories || 0} ospiti hanno raccontato` },
    { emoji:'ðŸ‘¥', label:'Ospiti unici', value: `${meta.unique_guests || 0}`, detail:`Da ${Object.keys(perYear).sort()[0]||'?'} a oggi` },
  ];
}

// ========== EPISODE MODAL ==========
function EpisodeModal({ ep, onClose, onTagClick, favs, setFavs, cidData }) {
  const [transcript, setTranscript] = useState(null);
  const [showTranscript, setShowTranscript] = useState(false);
  const [tSearch, setTSearch] = useState('');
  const [loading, setLoading] = useState(false);

  useEffect(() => { document.body.style.overflow='hidden'; return()=>{document.body.style.overflow=''}; }, []);
  useEffect(() => { const h=e=>{if(e.key==='Escape')onClose()}; window.addEventListener('keydown',h); return()=>window.removeEventListener('keydown',h); }, [onClose]);

  const loadTranscript = useCallback(async () => {
    if (transcript) { setShowTranscript(!showTranscript); return; }
    setLoading(true);
    try {
      const num = String(ep.episode_number).padStart(3,'0');
      const res = await fetch(`../data/transcripts/${num}.txt`);
      if (res.ok) { const t = await res.text(); setTranscript(t); setShowTranscript(true); }
    } catch(e) {}
    setLoading(false);
  }, [ep, transcript, showTranscript]);

  const cidInfo = cidData?.episodes?.find(c => c.episode_number === ep.episode_number);

  const filteredTranscript = useMemo(() => {
    if (!transcript || !tSearch || tSearch.length < 3) return transcript;
    return transcript;
  }, [transcript, tSearch]);

  const tSearchCount = useMemo(() => {
    if (!transcript || !tSearch || tSearch.length < 3) return 0;
    return (transcript.toLowerCase().match(new RegExp(tSearch.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g'))||[]).length;
  }, [transcript, tSearch]);

  const isFav = favs.includes(ep.youtube_id);

  return React.createElement('div', {className:'modal-overlay', onClick:e=>{if(e.target===e.currentTarget)onClose()}},
    React.createElement('div', {className:'modal'},
      React.createElement('button', {className:'modal-close', onClick:onClose}, 'âœ•'),
      React.createElement('div', {className:'modal-hero'},
        React.createElement('img', {src:ep.thumbnail_url, alt:ep.guest}),
        React.createElement('div', {className:'overlay'})
      ),
      React.createElement('div', {className:'modal-body'},
        React.createElement('div', {className:'modal-title'}, `Tintoria #${ep.episode_number}`),
        React.createElement('div', {className:'modal-guest'}, ep.guest),
        React.createElement('div', {className:'modal-meta'},
          ep.upload_date && React.createElement('span', null, 'ðŸ“… ', fmtDate(ep.upload_date)),
          React.createElement('span', null, 'â± ', fmtDur(ep.duration_seconds)),
          React.createElement('span', null, 'ðŸ‘ ', fmt(ep.view_count)),
          ep.professione?.length > 0 && React.createElement('span', null, 'ðŸ’¼ ', ep.professione.join(', '))
        ),
        React.createElement('div', {className:'modal-tags'},
          ...(ep.ambito||[]).map(a => React.createElement('span', {key:'a_'+a, className:'tag ambito', onClick:()=>{onClose();onTagClick('ambito',a)}}, a)),
          ...(ep.tags||[]).map(t => React.createElement('span', {key:'t_'+t, className:'tag', onClick:()=>{onClose();onTagClick('tag',t)}}, t))
        ),
        React.createElement('div', {className:'modal-actions'},
          React.createElement('a', {className:'btn btn-primary', href:ep.youtube_url, target:'_blank', rel:'noopener'}, 'â–¶ Guarda su YouTube'),
          React.createElement('button', {className:'btn btn-secondary', onClick:()=>toggleFav(ep.youtube_id,favs,setFavs)}, isFav?'â¤ï¸ Nei preferiti':'ðŸ¤ Aggiungi ai preferiti'),
          cidInfo && React.createElement('a', {className:'btn btn-cid', href:`${ep.youtube_url}&t=${cidInfo.estimated_timestamp_sec}`, target:'_blank', rel:'noopener'}, `ðŸ’© Vai alla rubrica (~${cidInfo.estimated_timestamp})`)
        ),
        cidInfo && React.createElement('div', {style:{marginBottom:16,padding:12,background:'rgba(251,191,36,0.06)',borderRadius:8,border:'1px solid rgba(251,191,36,0.15)'}},
          React.createElement('div', {style:{fontSize:14,fontWeight:600,color:'var(--yellow)',marginBottom:4}}, 'ðŸ’© Cacare in discoteca'),
          React.createElement('div', {style:{fontSize:13,color:'var(--text2)'}}, cidInfo.guest_tells_story ? 'âœ… L\'ospite racconta la sua storia' : 'âŒ L\'ospite non racconta'),
          cidInfo.segment_preview && React.createElement('div', {style:{fontSize:12,color:'var(--text3)',marginTop:8,fontStyle:'italic'}}, cidInfo.segment_preview.slice(0,200)+'â€¦')
        ),
        ep.has_transcription && React.createElement('div', {className:'transcript-section'},
          React.createElement('div', {className:'transcript-toggle', onClick:loadTranscript},
            loading ? React.createElement('span', {className:'spinner', style:{width:16,height:16}}) : null,
            React.createElement('span', null, showTranscript ? 'â–¼' : 'â–¶'),
            React.createElement('span', null, showTranscript ? 'Nascondi trascrizione' : 'Leggi la trascrizione'),
            ep.transcript_words && React.createElement('span', {style:{fontSize:12,color:'var(--text3)'}}, `(${(ep.transcript_words/1000).toFixed(1)}K parole)`)
          ),
          showTranscript && React.createElement('div', null,
            React.createElement('div', {className:'transcript-search'},
              React.createElement('input', {type:'text', placeholder:'Cerca nella trascrizione...', value:tSearch, onChange:e=>setTSearch(e.target.value)}),
              tSearch.length >= 3 && React.createElement('div', {style:{fontSize:12,color:'var(--text3)',marginTop:4}}, `${tSearchCount} risultati`)
            ),
            React.createElement('div', {className:'transcript-text', dangerouslySetInnerHTML:{
              __html: tSearch.length >= 3
                ? (filteredTranscript||'').replace(new RegExp(`(${tSearch.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>')
                : filteredTranscript || ''
            }})
          )
        )
      )
    )
  );
}

// ========== EPISODE CARD ==========
function EpisodeCard({ ep, onClick, onTagClick, favs, setFavs }) {
  const isFav = favs.includes(ep.youtube_id);
  return React.createElement('div', {className:'ep-card', onClick:()=>onClick(ep)},
    React.createElement('div', {className:'thumb'},
      React.createElement('img', {src:ep.thumbnail_url, alt:ep.guest, loading:'lazy'}),
      React.createElement('span', {className:'duration'}, fmtDur(ep.duration_seconds)),
      ep.is_numbered && React.createElement('span', {className:'ep-num'}, `#${ep.episode_number}`),
      React.createElement('button', {className:`fav-btn ${isFav?'faved':''}`, onClick:e=>{e.stopPropagation();toggleFav(ep.youtube_id,favs,setFavs)}}, isFav?'â¤':'â™¡')
    ),
    React.createElement('div', {className:'info'},
      React.createElement('div', {className:'guest'}, ep.guest),
      React.createElement('div', {className:'meta'},
        ep.upload_date && React.createElement('span', null, fmtDate(ep.upload_date)),
        React.createElement('span', null, fmt(ep.view_count)+' views')
      ),
      React.createElement('div', {className:'tags'},
        ...(ep.ambito||[]).slice(0,2).map(a => React.createElement('span', {key:'a_'+a, className:'tag ambito', onClick:e=>{e.stopPropagation();onTagClick('ambito',a)}}, a)),
        ...(ep.tags||[]).slice(0,3).map(t => React.createElement('span', {key:'t_'+t, className:'tag', onClick:e=>{e.stopPropagation();onTagClick('tag',t)}}, t))
      ),
      ep.has_rubrica_cid && React.createElement('div', {className:'cid-badge'}, 'ðŸ’© Cacare in discoteca')
    )
  );
}

// ========== DISCOVERY FLOW ==========
function DiscoveryFlow({ episodes, onSelect }) {
  const [step, setStep] = useState(0);
  const [ambito, setAmbito] = useState(null);
  const [mood, setMood] = useState(null);
  const [result, setResult] = useState(null);

  const ambiti = ['comedy', 'musica', 'cinema', 'tv', 'letteratura', 'web', 'giornalismo'];
  const moods = [
    {label:'Episodio popolare', key:'popular'},
    {label:'Gemma nascosta', key:'hidden'},
    {label:'Maratona lunga', key:'long'},
    {label:'Episodio breve', key:'short'},
  ];

  const findEpisode = (a, m) => {
    let pool = episodes.filter(e => e.is_numbered && (e.ambito||[]).includes(a));
    if (pool.length === 0) pool = episodes.filter(e => e.is_numbered);
    let sorted;
    switch(m) {
      case 'popular': sorted = [...pool].sort((a,b)=>b.view_count-a.view_count); break;
      case 'hidden': sorted = [...pool].sort((a,b)=>a.view_count-b.view_count); break;
      case 'long': sorted = [...pool].sort((a,b)=>b.duration_seconds-a.duration_seconds); break;
      case 'short': sorted = [...pool].sort((a,b)=>a.duration_seconds-b.duration_seconds); break;
      default: sorted = pool;
    }
    // Pick from top 5 randomly
    const top = sorted.slice(0, Math.min(5, sorted.length));
    return top[Math.floor(Math.random() * top.length)];
  };

  const reset = () => { setStep(0); setAmbito(null); setMood(null); setResult(null); };

  if (result) {
    return React.createElement('div', {className:'discovery'},
      React.createElement('h3', null, 'ðŸŽ¯ Ecco il tuo episodio!'),
      React.createElement('div', {className:'discovery-result', onClick:()=>onSelect(result)},
        React.createElement('div', {style:{fontSize:14,color:'var(--accent)',marginBottom:4}}, `#${result.episode_number}`),
        React.createElement('div', {style:{fontSize:20,fontWeight:700,marginBottom:4}}, result.guest),
        React.createElement('div', {style:{fontSize:14,color:'var(--text2)'}}, `${fmtDur(result.duration_seconds)} Â· ${fmt(result.view_count)} views`),
        React.createElement('div', {style:{marginTop:8,fontSize:13,color:'var(--text3)'}}, (result.ambito||[]).concat(result.tags||[]).join(' Â· '))
      ),
      React.createElement('div', {style:{marginTop:16,display:'flex',gap:8,justifyContent:'center'}},
        React.createElement('button', {className:'btn btn-secondary', onClick:()=>{setResult(findEpisode(ambito,mood))}}, 'ðŸ”„ Un altro'),
        React.createElement('button', {className:'btn btn-secondary', onClick:reset}, 'â†© Ricomincia')
      )
    );
  }

  return React.createElement('div', {className:'discovery'},
    React.createElement('h3', null, 'ðŸ§­ Non sai cosa guardare?'),
    React.createElement('p', null, 'Rispondi a due domande e ti consiglio un episodio'),
    step === 0 && React.createElement('div', {className:'discovery-step'},
      React.createElement('div', {className:'discovery-q'}, 'Che genere ti va?'),
      React.createElement('div', {className:'discovery-opts'},
        ...ambiti.map(a => React.createElement('button', {key:a, className:`discovery-opt ${ambito===a?'selected':''}`, onClick:()=>{setAmbito(a);setStep(1)}}, a)),
        React.createElement('button', {className:`discovery-opt ${ambito==='any'?'selected':''}`, onClick:()=>{setAmbito('any');setStep(1)}}, 'ðŸŽ² Qualsiasi')
      )
    ),
    step === 1 && React.createElement('div', {className:'discovery-step'},
      React.createElement('div', {className:'discovery-q'}, 'Che tipo di episodio?'),
      React.createElement('div', {className:'discovery-opts'},
        ...moods.map(m => React.createElement('button', {key:m.key, className:'discovery-opt', onClick:()=>{
          setMood(m.key);
          const a2 = ambito==='any'?ambiti[Math.floor(Math.random()*ambiti.length)]:ambito;
          setResult(findEpisode(a2, m.key));
        }}, m.label)),
        React.createElement('button', {className:'discovery-opt', onClick:()=>{
          const a2 = ambito==='any'?ambiti[Math.floor(Math.random()*ambiti.length)]:ambito;
          const pool = episodes.filter(e=>e.is_numbered&&((e.ambito||[]).includes(a2)||ambito==='any'));
          setResult(pool[Math.floor(Math.random()*pool.length)]);
        }}, 'ðŸŽ² Sorprendimi')
      )
    )
  );
}

// ========== MAIN APP ==========
function App() {
  const [episodes, setEpisodes] = useState([]);
  const [meta, setMeta] = useState({});
  const [cidData, setCidData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tab, setTab] = useState('episodi');
  const [selectedEp, setSelectedEp] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState(null);
  const [searchIndex, setSearchIndex] = useState(null);
  const [loadingSearch, setLoadingSearch] = useState(false);
  const [filterAmbito, setFilterAmbito] = useState(null);
  const [filterTag, setFilterTag] = useState(null);
  const [sortBy, setSortBy] = useState('number_desc');
  const [viewMode, setViewMode] = useState('grid');
  const [favs, setFavs] = useState(loadFavs());
  const [showBackTop, setShowBackTop] = useState(false);
  const [cidFilter, setCidFilter] = useState('all'); // all, story, no_story
  const [timelineYear, setTimelineYear] = useState(null);
  const searchRef = useRef(null);
  const snippetCache = useRef({});

  // Load data
  useEffect(() => {
    Promise.all([
      fetch('../data/episodes_tagged.json').then(r=>r.json()),
      fetch('../data/rubrica_cid.json').then(r=>r.json()).catch(()=>null)
    ]).then(([data, cid]) => {
      setEpisodes(data.episodes || []);
      setMeta(data.meta || {});
      setCidData(cid);
      setLoading(false);
    });
  }, []);

  // Keyboard shortcuts
  useEffect(() => {
    const h = e => {
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement?.tagName !== 'INPUT') {
        e.preventDefault(); searchRef.current?.focus();
      }
    };
    window.addEventListener('keydown', h);
    return () => window.removeEventListener('keydown', h);
  }, []);

  // Back to top
  useEffect(() => {
    const h = () => setShowBackTop(window.scrollY > 400);
    window.addEventListener('scroll', h);
    return () => window.removeEventListener('scroll', h);
  }, []);

  // Search logic - lazy load index
  useEffect(() => {
    if (searchQuery.length >= 4 && !searchIndex && !loadingSearch) {
      setLoadingSearch(true);
      fetch('../data/search_index.json').then(r=>r.json()).then(idx => {
        setSearchIndex(idx);
        setLoadingSearch(false);
      }).catch(() => setLoadingSearch(false));
    }
  }, [searchQuery, searchIndex, loadingSearch]);

  // Perform search
  useEffect(() => {
    if (!searchQuery || searchQuery.length < 4 || !searchIndex) { setSearchResults(null); return; }
    const q = searchQuery.toLowerCase();
    const words = q.split(/\s+/).filter(w => w.length >= 3);
    if (words.length === 0) { setSearchResults(null); return; }

    // Find episodes matching all words
    let matchEps = null;
    words.forEach(w => {
      const epNums = new Set();
      Object.keys(searchIndex).forEach(term => {
        if (term.includes(w)) searchIndex[term].forEach(n => epNums.add(n));
      });
      matchEps = matchEps ? new Set([...matchEps].filter(n => epNums.has(n))) : epNums;
    });

    const results = [...(matchEps || [])].map(num => {
      const ep = episodes.find(e => e.episode_number === num);
      return ep ? { ep, num } : null;
    }).filter(Boolean);

    // Load snippets for top results
    results.slice(0, 20).forEach(r => {
      const key = String(r.num).padStart(3, '0');
      if (!snippetCache.current[key]) {
        snippetCache.current[key] = '';
        fetch(`../data/search_snippets/${key}.txt`).then(res => res.ok ? res.text() : '').then(t => {
          snippetCache.current[key] = t;
          setSearchResults(prev => prev ? [...prev] : prev); // force re-render
        }).catch(() => {});
      }
    });

    setSearchResults(results);
  }, [searchQuery, searchIndex, episodes]);

  // Tag click handler
  const handleTagClick = useCallback((type, value) => {
    setTab('episodi');
    if (type === 'ambito') { setFilterAmbito(value); setFilterTag(null); }
    else { setFilterTag(value); setFilterAmbito(null); }
    setSearchQuery(''); setSearchResults(null);
  }, []);

  // Guest index
  const guestIndex = useMemo(() => buildGuestIndex(episodes), [episodes]);
  const recurringGuests = useMemo(() =>
    Object.entries(guestIndex).filter(([_,eps]) => eps.length > 1).sort((a,b) => b[1].length - a[1].length)
  , [guestIndex]);
  const allGuests = useMemo(() =>
    Object.entries(guestIndex).sort((a,b) => a[0].localeCompare(b[0]))
  , [guestIndex]);

  // Stats
  const stats = useMemo(() => episodes.length > 0 ? buildStats(episodes, meta) : [], [episodes, meta]);

  // Timeline data
  const timelineData = useMemo(() => {
    const data = {};
    episodes.filter(e => e.is_numbered && e.upload_date).forEach(ep => {
      const ym = ep.upload_date.slice(0, 7); // YYYY-MM
      if (!data[ym]) data[ym] = [];
      data[ym].push(ep);
    });
    return Object.entries(data).sort((a,b) => a[0].localeCompare(b[0]));
  }, [episodes]);

  const maxPerMonth = useMemo(() => Math.max(...timelineData.map(([_,eps]) => eps.length), 1), [timelineData]);

  // Filter & sort episodes
  const filtered = useMemo(() => {
    let f = episodes.filter(e => e.is_numbered);
    if (filterAmbito) f = f.filter(e => (e.ambito||[]).includes(filterAmbito));
    if (filterTag) f = f.filter(e => (e.tags||[]).includes(filterTag));
    if (timelineYear) f = f.filter(e => (e.upload_date||'').startsWith(timelineYear));
    // Sort
    switch(sortBy) {
      case 'number_desc': f.sort((a,b) => b.episode_number - a.episode_number); break;
      case 'number_asc': f.sort((a,b) => a.episode_number - b.episode_number); break;
      case 'views_desc': f.sort((a,b) => b.view_count - a.view_count); break;
      case 'views_asc': f.sort((a,b) => a.view_count - b.view_count); break;
      case 'date_desc': f.sort((a,b) => (b.upload_date||'').localeCompare(a.upload_date||'')); break;
      case 'duration_desc': f.sort((a,b) => (b.duration_seconds||0) - (a.duration_seconds||0)); break;
    }
    return f;
  }, [episodes, filterAmbito, filterTag, sortBy, timelineYear]);

  // Favorites
  const favEpisodes = useMemo(() => episodes.filter(e => favs.includes(e.youtube_id)), [episodes, favs]);

  // CID episodes
  const cidEpisodes = useMemo(() => {
    if (!cidData) return [];
    let eps = cidData.episodes || [];
    if (cidFilter === 'story') eps = eps.filter(e => e.guest_tells_story);
    if (cidFilter === 'no_story') eps = eps.filter(e => !e.guest_tells_story);
    return eps;
  }, [cidData, cidFilter]);

  if (loading) return React.createElement('div', {className:'loading'}, React.createElement('div', {className:'spinner'}), React.createElement('p', {style:{marginTop:16}}, 'Caricamento...'));

  const numbered = episodes.filter(e => e.is_numbered);
  const ambiti = Object.entries(meta.ambiti_counts || {}).sort((a,b) => b[1] - a[1]);
  const topTags = Object.entries(meta.top_tags || {}).sort((a,b) => b[1] - a[1]).slice(0, 15);

  return React.createElement('div', null,
    // NAV
    React.createElement('div', {className:'nav'},
      React.createElement('div', {className:'nav-inner'},
        React.createElement('span', {className:'nav-logo', onClick:()=>{setTab('episodi');setFilterAmbito(null);setFilterTag(null);setTimelineYear(null);setSearchQuery('');setSearchResults(null)}}, 'TintorIA'),
        React.createElement('button', {className:`nav-tab ${tab==='episodi'?'active':''}`, onClick:()=>setTab('episodi')}, 'Episodi'),
        React.createElement('button', {className:`nav-tab ${tab==='cid'?'active':''}`, onClick:()=>setTab('cid')}, 'ðŸ’© Rubrica'),
        React.createElement('button', {className:`nav-tab ${tab==='ospiti'?'active':''}`, onClick:()=>setTab('ospiti')}, 'Ospiti'),
        React.createElement('button', {className:`nav-tab ${tab==='stats'?'active':''}`, onClick:()=>setTab('stats')}, 'Stats'),
        React.createElement('button', {className:`nav-tab ${tab==='scopri'?'active':''}`, onClick:()=>setTab('scopri')}, 'ðŸ§­ Scopri'),
        favs.length > 0 && React.createElement('button', {className:`nav-tab ${tab==='preferiti'?'active':''}`, onClick:()=>setTab('preferiti')}, `â¤ ${favs.length}`),
        React.createElement('div', {className:'nav-search'},
          React.createElement('span', {className:'search-icon'}, 'ðŸ”'),
          React.createElement('input', {ref:searchRef, type:'text', placeholder:'Cerca nei transcript...', value:searchQuery, onChange:e=>{setSearchQuery(e.target.value);if(e.target.value.length>=4)setTab('episodi')}}),
          React.createElement('span', {className:'nav-shortcut'}, '/')
        )
      )
    ),

    // HERO (only on episodi tab without search)
    tab === 'episodi' && !searchResults && !filterAmbito && !filterTag && !timelineYear && React.createElement('div', {className:'hero'},
      React.createElement('h1', null, 'Tintor', React.createElement('span', null, 'IA')),
      React.createElement('div', {className:'subtitle'}, 'L\'archivio intelligente di Tintoria'),
      React.createElement('div', {className:'hero-stats'},
        React.createElement('div', {className:'hero-stat'}, React.createElement('div', {className:'num'}, numbered.length), React.createElement('div', {className:'label'}, 'Episodi')),
        React.createElement('div', {className:'hero-stat'}, React.createElement('div', {className:'num'}, fmt(meta.total_views||0)), React.createElement('div', {className:'label'}, 'Views totali')),
        React.createElement('div', {className:'hero-stat'}, React.createElement('div', {className:'num'}, meta.unique_guests||0), React.createElement('div', {className:'label'}, 'Ospiti')),
        React.createElement('div', {className:'hero-stat'}, React.createElement('div', {className:'num'}, meta.transcriptions_count||0), React.createElement('div', {className:'label'}, 'Trascrizioni')),
        React.createElement('div', {className:'hero-stat'}, React.createElement('div', {className:'num'}, meta.rubrica_cid_count||0), React.createElement('div', {className:'label'}, 'ðŸ’© Rubrica CID'))
      )
    ),

    React.createElement('div', {className:'main'},

      // ======= SEARCH RESULTS =======
      searchResults && tab === 'episodi' && React.createElement('div', null,
        React.createElement('div', {className:'section-header'},
          React.createElement('div', null,
            React.createElement('div', {className:'section-title'}, `Risultati per "${searchQuery}"`),
            React.createElement('div', {className:'section-subtitle'}, `${searchResults.length} episodi trovati`)
          ),
          React.createElement('button', {className:'btn btn-secondary', onClick:()=>{setSearchQuery('');setSearchResults(null)}}, 'âœ• Chiudi ricerca')
        ),
        loadingSearch && React.createElement('div', {className:'loading'}, React.createElement('div', {className:'spinner'})),
        React.createElement('div', {className:'search-results'},
          ...searchResults.slice(0,30).map(({ep, num}) => {
            const key = String(num).padStart(3, '0');
            const snippet = snippetCache.current[key] || '';
            return React.createElement('div', {key:ep.youtube_id, className:'search-result', onClick:()=>setSelectedEp(ep)},
              React.createElement('div', {className:'sr-guest'}, `#${ep.episode_number} â€” ${ep.guest}`),
              React.createElement('div', {style:{fontSize:12,color:'var(--text3)',marginBottom:4}}, `${fmtDate(ep.upload_date)} Â· ${fmt(ep.view_count)} views`),
              snippet && React.createElement('div', {className:'sr-snippet', dangerouslySetInnerHTML:{__html: getSnippet(snippet, searchQuery).replace(new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>')}})
            );
          })
        )
      ),

      // ======= EPISODI TAB =======
      tab === 'episodi' && !searchResults && React.createElement('div', null,
        // Timeline
        timelineData.length > 0 && React.createElement('div', {className:'timeline'},
          React.createElement('div', {style:{display:'flex',justifyContent:'space-between',marginBottom:8}},
            React.createElement('span', {style:{fontSize:13,color:'var(--text3)'}}, 'Timeline'),
            timelineYear && React.createElement('button', {className:'btn btn-secondary', style:{padding:'2px 10px',fontSize:12}, onClick:()=>setTimelineYear(null)}, `âœ• ${timelineYear}`)
          ),
          React.createElement('div', {className:'timeline-bar'},
            ...timelineData.map(([ym, eps]) => {
              const year = ym.slice(0,4);
              const height = Math.max(8, (eps.length / maxPerMonth) * 40);
              const isActive = timelineYear === year;
              return React.createElement('div', {
                key:ym, className:`timeline-segment ${isActive?'active':''}`,
                style:{flex:1}, title:`${ym}: ${eps.length} episodi`,
                onClick:() => setTimelineYear(timelineYear===year ? null : year)
              },
                React.createElement('div', {className:'bar', style:{height}}),
                ym.endsWith('-01') && React.createElement('span', {className:'label'}, year)
              );
            })
          )
        ),
        // Filters
        React.createElement('div', {className:'filters'},
          React.createElement('span', {style:{fontSize:13,color:'var(--text3)',marginRight:4}}, 'Ambito:'),
          ...ambiti.slice(0,10).map(([a,c]) => React.createElement('button', {key:a, className:`filter-chip ${filterAmbito===a?'active':''}`, onClick:()=>setFilterAmbito(filterAmbito===a?null:a)}, a, React.createElement('span', {className:'count'}, c))),
          (filterAmbito || filterTag) && React.createElement('button', {className:'filter-chip', style:{color:'var(--red)',borderColor:'var(--red)'}, onClick:()=>{setFilterAmbito(null);setFilterTag(null)}}, 'âœ• Reset')
        ),
        filterTag && React.createElement('div', {style:{marginBottom:12,fontSize:14,color:'var(--text2)'}}, `Tag: "${filterTag}"`),
        // Controls
        React.createElement('div', {style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16,flexWrap:'wrap',gap:8}},
          React.createElement('div', {className:'results-count'}, `${filtered.length} episodi`),
          React.createElement('div', {className:'controls'},
            React.createElement('select', {className:'sort-select', value:sortBy, onChange:e=>setSortBy(e.target.value)},
              React.createElement('option', {value:'number_desc'}, 'PiÃ¹ recenti'),
              React.createElement('option', {value:'number_asc'}, 'PiÃ¹ vecchi'),
              React.createElement('option', {value:'views_desc'}, 'PiÃ¹ visti'),
              React.createElement('option', {value:'views_asc'}, 'Meno visti'),
              React.createElement('option', {value:'duration_desc'}, 'PiÃ¹ lunghi')
            ),
            React.createElement('button', {className:`control-btn ${viewMode==='grid'?'active':''}`, onClick:()=>setViewMode('grid')}, 'â–¦'),
            React.createElement('button', {className:`control-btn ${viewMode==='list'?'active':''}`, onClick:()=>setViewMode('list')}, 'â˜°'),
            React.createElement('button', {className:'control-btn', onClick:()=>{const r=filtered[Math.floor(Math.random()*filtered.length)];if(r)setSelectedEp(r)}}, 'ðŸŽ²')
          )
        ),
        // Grid or List
        viewMode === 'grid'
          ? React.createElement('div', {className:'ep-grid'}, ...filtered.map(ep => React.createElement(EpisodeCard, {key:ep.youtube_id, ep, onClick:setSelectedEp, onTagClick:handleTagClick, favs, setFavs})))
          : React.createElement('div', {className:'ep-list'}, ...filtered.map(ep =>
              React.createElement('div', {key:ep.youtube_id, className:'ep-row', onClick:()=>setSelectedEp(ep)},
                React.createElement('span', {className:'num'}, `#${ep.episode_number}`),
                React.createElement('span', {className:'guest'}, ep.guest),
                ep.has_rubrica_cid && React.createElement('span', {style:{fontSize:12}}, 'ðŸ’©'),
                React.createElement('span', {className:'meta-item'}, fmtDate(ep.upload_date)),
                React.createElement('span', {className:'meta-item'}, fmt(ep.view_count)),
                React.createElement('span', {className:'meta-item'}, fmtDur(ep.duration_seconds))
              )
            ))
      ),

      // ======= CID TAB =======
      tab === 'cid' && React.createElement('div', {className:'cid-section'},
        React.createElement('div', {className:'cid-intro'},
          React.createElement('h3', null, 'ðŸ’© Cacare in discoteca'),
          React.createElement('p', null, 'La rubrica piÃ¹ amata di Tintoria. Daniele chiede a ogni ospite di raccontare la propria esperienza piÃ¹ imbarazzante legata ai bagni. Qualcuno racconta, qualcuno si rifiuta, qualcuno nega di aver mai avuto problemi. Ma tutti, prima o poi, cagano in discoteca.'),
          React.createElement('div', {className:'cid-stats'},
            React.createElement('div', {className:'cid-stat'}, React.createElement('div', {className:'n'}, cidData?.meta?.total_episodes_with_rubrica||0), React.createElement('div', {className:'l'}, 'Episodi')),
            React.createElement('div', {className:'cid-stat'}, React.createElement('div', {className:'n'}, cidData?.meta?.guests_with_stories||0), React.createElement('div', {className:'l'}, 'Raccontano')),
            React.createElement('div', {className:'cid-stat'}, React.createElement('div', {className:'n'}, cidData?.meta?.guests_without_stories||0), React.createElement('div', {className:'l'}, 'Si rifiutano'))
          )
        ),
        React.createElement('div', {className:'filters', style:{marginBottom:16}},
          React.createElement('button', {className:`filter-chip ${cidFilter==='all'?'active':''}`, onClick:()=>setCidFilter('all')}, 'Tutti'),
          React.createElement('button', {className:`filter-chip ${cidFilter==='story'?'active':''}`, onClick:()=>setCidFilter('story')}, 'âœ… Raccontano'),
          React.createElement('button', {className:`filter-chip ${cidFilter==='no_story'?'active':''}`, onClick:()=>setCidFilter('no_story')}, 'âŒ Non raccontano')
        ),
        React.createElement('div', {className:'results-count'}, `${cidEpisodes.length} episodi`),
        React.createElement('div', {className:'ep-grid'},
          ...cidEpisodes.map(c => {
            const ep = episodes.find(e => e.episode_number === c.episode_number);
            return React.createElement('div', {key:c.episode_number, className:'cid-card', onClick:()=>ep&&setSelectedEp(ep)},
              React.createElement('div', {className:'cid-top'},
                React.createElement('img', {className:'cid-thumb', src:c.thumbnail_url, alt:c.guest, loading:'lazy'}),
                React.createElement('div', {className:'cid-info'},
                  React.createElement('div', {className:'cid-guest'}, `#${c.episode_number} â€” ${c.guest}`),
                  React.createElement('div', {className:'cid-meta'}, `${fmtDate(c.date)} Â· ~${c.estimated_timestamp}`),
                  React.createElement('span', {className:`story-badge ${c.guest_tells_story?'yes':'no'}`}, c.guest_tells_story ? 'âœ… Racconta' : 'âŒ Non racconta')
                )
              ),
              c.segment_preview && React.createElement('div', {className:'cid-preview'}, c.segment_preview.slice(0,150)+'â€¦'),
              React.createElement('div', {style:{padding:'0 14px 12px'}},
                React.createElement('a', {className:'btn btn-cid', style:{fontSize:12,padding:'4px 12px'}, href:`${c.youtube_url}&t=${c.estimated_timestamp_sec}`, target:'_blank', rel:'noopener', onClick:e=>e.stopPropagation()}, `â–¶ Vai a ~${c.estimated_timestamp}`)
              )
            );
          })
        )
      ),

      // ======= OSPITI TAB =======
      tab === 'ospiti' && React.createElement('div', null,
        React.createElement('div', {className:'section-header'},
          React.createElement('div', {className:'section-title'}, 'Tutti gli ospiti'),
          React.createElement('div', {className:'section-subtitle'}, `${allGuests.length} ospiti unici, ${recurringGuests.length} ricorrenti`)
        ),
        recurringGuests.length > 0 && React.createElement('div', null,
          React.createElement('h3', {style:{fontSize:16,fontWeight:600,marginBottom:12,color:'var(--accent)'}}, 'Ospiti ricorrenti'),
          React.createElement('div', {className:'guest-grid', style:{marginBottom:32}},
            ...recurringGuests.map(([name, eps]) => React.createElement('div', {key:name, className:'guest-card'},
              React.createElement('div', {className:'g-name'}, name),
              React.createElement('div', {className:'g-count'}, `${eps.length} episodi`),
              React.createElement('div', {className:'g-episodes'},
                ...eps.map(ep => React.createElement('span', {key:ep.episode_number, style:{cursor:'pointer',marginRight:8}, onClick:()=>setSelectedEp(ep)},
                  React.createElement('span', {style:{color:'var(--accent)'}}, `#${ep.episode_number}`),
                  ' ', ep.guest?.replace(name,'').replace(/^[\s,&(]+|[\s,&)]+$/g,'').replace(/^con\s*/i,'').replace(/^LIVE\s*/,'') || ''
                ))
              )
            ))
          )
        ),
        React.createElement('h3', {style:{fontSize:16,fontWeight:600,marginBottom:12}}, 'Tutti gli ospiti (A-Z)'),
        React.createElement('div', {className:'guest-grid'},
          ...allGuests.map(([name, eps]) => React.createElement('div', {key:name, className:'guest-card', onClick:()=>{if(eps.length===1)setSelectedEp(eps[0])}},
            React.createElement('div', {className:'g-name'}, name),
            eps.length > 1 && React.createElement('div', {className:'g-count'}, `${eps.length} episodi`),
            React.createElement('div', {className:'g-episodes'},
              ...eps.slice(0,5).map(ep => React.createElement('span', {key:ep.episode_number, style:{cursor:'pointer',marginRight:8}, onClick:e=>{e.stopPropagation();setSelectedEp(ep)}},
                React.createElement('span', {style:{color:'var(--accent)'}}, `#${ep.episode_number}`)
              )),
              eps.length > 5 && React.createElement('span', {style:{color:'var(--text3)'}}, `+${eps.length-5}`)
            )
          ))
        )
      ),

      // ======= STATS TAB =======
      tab === 'stats' && React.createElement('div', null,
        React.createElement('div', {className:'section-header'},
          React.createElement('div', {className:'section-title'}, 'Lo sapevi cheâ€¦')
        ),
        React.createElement('div', {className:'stats-grid'},
          ...stats.map((s,i) => React.createElement('div', {key:i, className:'stat-card', onClick:()=>{if(s.ep)setSelectedEp(s.ep)}},
            React.createElement('div', {className:'stat-emoji'}, s.emoji),
            React.createElement('div', {className:'stat-label'}, s.label),
            React.createElement('div', {className:'stat-value'}, s.value),
            React.createElement('div', {className:'stat-detail'}, s.detail)
          ))
        ),
        // Tag cloud
        React.createElement('div', {className:'section-header', style:{marginTop:40}},
          React.createElement('div', {className:'section-title'}, 'Mappa dei temi')
        ),
        React.createElement('div', {style:{display:'flex',gap:8,flexWrap:'wrap'}},
          ...ambiti.map(([a,c]) => React.createElement('button', {key:a, className:'filter-chip', style:{fontSize:Math.max(12, Math.min(20, 10+c/5))+'px'}, onClick:()=>{setTab('episodi');setFilterAmbito(a)}}, `${a} (${c})`))
        ),
        React.createElement('div', {style:{marginTop:20,display:'flex',gap:6,flexWrap:'wrap'}},
          ...topTags.map(([t,c]) => React.createElement('button', {key:t, className:'filter-chip', onClick:()=>{setTab('episodi');setFilterTag(t)}}, `${t} (${c})`))
        ),
        // Years breakdown
        React.createElement('div', {className:'section-header', style:{marginTop:40}},
          React.createElement('div', {className:'section-title'}, 'Episodi per anno')
        ),
        React.createElement('div', {style:{display:'flex',gap:16,flexWrap:'wrap'}},
          ...Object.entries(
            episodes.filter(e=>e.is_numbered&&e.upload_date).reduce((acc,e)=>{const y=e.upload_date.slice(0,4);acc[y]=(acc[y]||0)+1;return acc},{})
          ).sort((a,b)=>a[0].localeCompare(b[0])).map(([y,c]) =>
            React.createElement('div', {key:y, className:'stat-card', style:{cursor:'pointer',flex:'1',minWidth:120}, onClick:()=>{setTab('episodi');setTimelineYear(y)}},
              React.createElement('div', {style:{fontSize:24,fontWeight:800,color:'var(--accent)'}}, c),
              React.createElement('div', {style:{fontSize:14,color:'var(--text2)'}}, y)
            )
          )
        )
      ),

      // ======= SCOPRI TAB =======
      tab === 'scopri' && React.createElement(DiscoveryFlow, {episodes, onSelect:setSelectedEp}),

      // ======= PREFERITI TAB =======
      tab === 'preferiti' && React.createElement('div', null,
        React.createElement('div', {className:'section-header'},
          React.createElement('div', {className:'section-title'}, 'â¤ I tuoi preferiti'),
          React.createElement('div', {className:'section-subtitle'}, `${favEpisodes.length} episodi salvati`)
        ),
        favEpisodes.length === 0
          ? React.createElement('div', {className:'fav-empty'},
              React.createElement('div', {className:'icon'}, 'ðŸ¤'),
              React.createElement('p', null, 'Nessun preferito ancora.'),
              React.createElement('p', {style:{fontSize:13,marginTop:4}}, 'Clicca il cuoricino su un episodio per salvarlo qui.')
            )
          : React.createElement('div', {className:'ep-grid'}, ...favEpisodes.map(ep => React.createElement(EpisodeCard, {key:ep.youtube_id, ep, onClick:setSelectedEp, onTagClick:handleTagClick, favs, setFavs})))
      )
    ),

    // Modal
    selectedEp && React.createElement(EpisodeModal, {ep:selectedEp, onClose:()=>setSelectedEp(null), onTagClick:handleTagClick, favs, setFavs, cidData}),

    // Back to top
    React.createElement('button', {className:`back-top ${showBackTop?'visible':''}`, onClick:()=>window.scrollTo({top:0,behavior:'smooth'})}, 'â†‘')
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
